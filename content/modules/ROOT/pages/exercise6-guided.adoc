[#fix]
= Live Migration failed

== Scenario

The user is attempting to migrate a virtual machine from one node to another using live migration.

The primary goal is to investigate the cause of the live migration failure and take corrective action to successfully migrate the `exercise6` virtual machine to another node. Your task is to identify the root cause and resolve the issue.

The steps to fix exercise6 are:

=== Console

1. Login to OpenShift console using the assigned user account.

2. Go to Virtualization - VirtualMachines - Select the project for the assigned user account - look for VM called `exercise6`.

image::exercise6/01-step2.png[]

[start=3]
3. Open the Virtual Machine `exercise6` to get its details.

image::exercise6/02-step3.png[]

[start=4]
4. Try to migrate the virtual machine using Live Migration. Migration is going to fail.

image::exercise6/03-step4.png[]

[start=5]
5. Examine the logs of the `virt-launcher-exercise6` pod to identify the root cause. 
5.1 Go to the project for the assigned user account and then look for the failed pod.

image::exercise6/04-step5-1.png[]

5.2 Check the pod logs. The issue occurs because the virtual machine disks are configured as read-only, preventing migration. 

[source]
----
{"component":"virt-launcher","level":"error","msg":"Operation not supported: Cannot migrate empty or read-only disk vdb","pos":"qemuMigrationDstStartNBDServer:628","subcomponent":"libvirt","thread":"33","timestamp":"2024-11-20T11:44:26.459000Z"}
----

[start=6]
6. Stop the virtual machine to edit its configuration.


[start=7]
7. Edit the virtual machine and remove the fields `readonly: true` from the VM disks.


[start=8]
8. Start again the virtual machine.
9. Migrate virtual machine.
10. The virtual machine should be migrated to another node successfully.
----

=== CLI
----
1. Login to Openshift server api using the assigned user account with oc command
2. Go to assigned namespace-{{ user }}
3. Check there is a virtual machine running in this namespace
4. Create a `VirtualMachineInstanceMigration` resource for the VM that you want to migrate:

----
    apiVersion: kubevirt.io/v1
    kind: VirtualMachineInstanceMigration
    metadata:
      name: exercise6-migration
    spec:
      vmiName: exercise6
----

5. Create the object by running the following command:

----
    oc create -f <migration_name>.yaml
----

6. Check the `VirtualMachineInstanceMigratio` status.
7. Stop the virtual machine
8. Edit the virtual machine and remove the fields `readonly: true` from the VM disks
9. Start again the virtual machine.
10. Create a new `VirtualMachineInstanceMigration` resource

----
    apiVersion: kubevirt.io/v1
    kind: VirtualMachineInstanceMigration
    metadata:
    name: exercise6-success-migration
    spec:
    vmiName: exercise6
----

11. The virtual machine should be migrated to another node successfully.

----